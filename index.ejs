<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Portfolio</title>
    <link rel="stylesheet" href="/index.css" />
</head>
<body>
    <a href="/logout" class="logout-btn">Logout</a>
    
    <div class="container">
        <h1>My Crypto Portfolio</h1>

        <div class="card">
            <h3>Manage Asset</h3>
            <form action="/portfolio/add" method="POST">
                
                <select name="action" required>
                    <option value="add">Add (+)</option>
                    <option value="subtract">Subtract (-)</option>
                </select>

                <input 
                    type="text" 
                    name="coinId" 
                    placeholder="Crypto Name (e.g. Bitcoin)" 
                    required 
                />

                <input 
                    type="number" 
                    name="amount" 
                    step="any" 
                    placeholder="Amount" 
                    required 
                />

                <button type="submit">Update Portfolio</button>
            </form>
        </div>

        <div class="card">
            <h3>Current Holdings</h3>

            <% if (typeof error !== 'undefined') { %>
                <p class="error" style="color: red; background: rgba(255,0,0,0.1); padding: 5px;">
                    <%= error %>
                </p>
            <% } %>

            <table>
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Amount</th>
                        <th>Market Price</th>
                        <th>Your Value</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% 
                        let totalValue = 0; 
                        
                        portfolio.forEach(item => { 
                            // Safe calculation logic
                            const price = prices[item.coinId] ? prices[item.coinId].usd : 0;
                            const val = (price * item.amount).toFixed(2);
                            totalValue += parseFloat(val);
                    %>
                    <tr>
                        <td>
                            <%= item.coinName.charAt(0).toUpperCase() + item.coinName.slice(1) %>
                        </td>
                        <td><%= item.amount %></td>
                        <td>$<%= price.toLocaleString() %></td>
                        <td style="color: forestgreen">$<%= val %></td>
                        <td>
                            <form action="/portfolio/delete" method="POST" style="margin: 0">
                                <input type="hidden" name="id" value="<%= item._id %>" />
                                <button type="submit" class="delete-btn" style="background: #ff4444; color: white; padding: 2px 8px; cursor: pointer; border:none;">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>

            <div class="total" style="text-align: right; margin-top: 20px; font-size: 1.5rem; border-top: 1px solid #444; padding-top: 10px;">
                Total Net Worth: $<%= totalValue.toLocaleString() %>
            </div>
        </div>
    </div>
</body>
</html>